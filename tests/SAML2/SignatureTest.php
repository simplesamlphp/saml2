<?php

class SAML2_SignatureTest extends PHPUnit_Framework_TestCase {


    public
    function data() {
        return array(
            // this is a good xml generated by ADFS
            array("<samlp:Response ID=\"_b9f50e55-bbc9-4a27-9894-ae157c31798c\" Version=\"2.0\" IssueInstant=\"2014-05-02T20:27:01.673Z\" Destination=\"https://qa.vminyaylo.centraldesktop-dev.com/saml2-assertion.php\" Consent=\"urn:oasis:names:tc:SAML:2.0:consent:unspecified\" InResponseTo=\"_bbe719ca2beb0e43346eefd0b2\" xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\"><Issuer xmlns=\"urn:oasis:names:tc:SAML:2.0:assertion\">https://eng-auth0.centraldesktop-dev.com/adfs/services/trust</Issuer><samlp:Status><samlp:StatusCode Value=\"urn:oasis:names:tc:SAML:2.0:status:Success\" /></samlp:Status><Assertion ID=\"_79c35370-c286-453c-81a6-fc5a264a7b9a\" IssueInstant=\"2014-05-02T20:27:01.673Z\" Version=\"2.0\" xmlns=\"urn:oasis:names:tc:SAML:2.0:assertion\"><Issuer>https://eng-auth0.centraldesktop-dev.com/adfs/services/trust</Issuer><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" /><ds:SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\" /><ds:Reference URI=\"#_79c35370-c286-453c-81a6-fc5a264a7b9a\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" /><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" /></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\" /><ds:DigestValue>Hf815vRWWxA08BJn5keSIWkqo3TrEzHqUdmeJMjRtdQ=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>I5D5jy5s+PkWJbRAOQq+RQtSnwcR1DRfokotod3eqPxI822deWiY3lAncESETCr+rCmK4EaIm9P13vvOuk0Jgni7PnVIGgrQo5t6rMRvkbtxOjg8Ht6RFXiYUPBCKaluWOuf3+52jvpP/qKgQWjmvq8xouUVKXhPXPm4mEOt7R7NubUDSx3cr8TFjo8PLhWZ9ZmR9x9xJKlRoFONkTHX99NIW9oMMQ4wIm4Nu55PjL6FRbIaM5XzsErH0oEpEGsGNV47xXVDczExAkvC0wRQYpuxqsU6lKv9tHPTCmLB/jVRGZ7byWePnmiuaCfUKlXz8n26tLjWnk2Se9Y+pvMiYQ==</ds:SignatureValue><KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIC/DCCAeSgAwIBAgIQZGJgaN56E4BHraEF7tgu6TANBgkqhkiG9w0BAQsFADA6MTgwNgYDVQQDEy9BREZTIFNpZ25pbmcgLSBlbmctYXV0aDAuY2VudHJhbGRlc2t0b3AtZGV2LmNvbTAeFw0xNDA0MDQwMDI1NTRaFw0xNTA0MDQwMDI1NTRaMDoxODA2BgNVBAMTL0FERlMgU2lnbmluZyAtIGVuZy1hdXRoMC5jZW50cmFsZGVza3RvcC1kZXYuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtjH72YmawiYlD3hNqKQhkJXKvNa9QjovyVuRt8ieVazQZh02c1aJcI9RFt9ZhctNO1C3ve8xX/aULfMwgL3YCi6IwMJp2YQ/47Zp1mHEUAvw6PBAJdOVue4rku66hIxs0/vgtD75qf4WXhA1UlkZ/97CTHqG9BgqMb9B2b7AzM7Yv22VTkQ89i2XsW7efA5aNJAe99yE1ch3jP4xEegIaBdrkg8ojJGfRwtl8wJqz1zFDP/dXnqjT5Hn2nCnDdXYFuiGF/HzzaYpqTsh7aHu5DtipVicHAqXv5vyWh0zpuhPItPkP85fouCutqWMCnYQ81U1DbDCr95KP8r6NStLhQIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQA5pBkuxgU8hYbTz+I831nLt1BSGp584L8ers6ktawjD0PVwnSLWcUlri8h+ra/qAyjAathuz7l7uqMxBAeppayZCuMv2bR+NmRkmq73wS8tWAxJMed3OpTH8HLJ7U/1LDiSTGLihyeJ9fMLlgMg9nlQD6iwLRy+6lDWZhlTXCkPiP9gBxyYoCK4Dl8oKIn8KqYvhvlJ++MiO9wR7/5y+ShbZTetiPjxHvsymcMC4ZduC8yDQy/XPbPCALmnKaKXCLBIhhggunwHuWDSApEilf0A20ZkiKXc8aNrwoFTu7mR795RynPkzvpYCExjYSx9wRs+HCbTckBDIqVWaSxRrGa</ds:X509Certificate></ds:X509Data></KeyInfo></ds:Signature><Subject><NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress\">samltest@centraldesktop-dev.com</NameID><SubjectConfirmation Method=\"urn:oasis:names:tc:SAML:2.0:cm:bearer\"><SubjectConfirmationData InResponseTo=\"_bbe719ca2beb0e43346eefd0b2\" NotOnOrAfter=\"2014-05-02T20:32:01.673Z\" Recipient=\"https://qa.vminyaylo.centraldesktop-dev.com/saml2-assertion.php\" /></SubjectConfirmation></Subject><Conditions NotBefore=\"2014-05-02T20:27:01.658Z\" NotOnOrAfter=\"2014-05-02T21:27:01.658Z\"><AudienceRestriction><Audience>https://qa.vminyaylo.centraldesktop-dev.com/saml2-metadata.php</Audience></AudienceRestriction></Conditions><AttributeStatement><Attribute Name=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress\"><AttributeValue>samltest@centraldesktop-dev.com</AttributeValue></Attribute><Attribute Name=\"fullname\"><AttributeValue>Saml Test</AttributeValue></Attribute><Attribute Name=\"firstname\"><AttributeValue>Saml</AttributeValue></Attribute><Attribute Name=\"lastname\"><AttributeValue>Test</AttributeValue></Attribute><Attribute Name=\"company\"><AttributeValue>SAML Company</AttributeValue></Attribute><Attribute Name=\"memberof\"><AttributeValue>CN=Test Group 1,CN=Users,DC=centraldesktop-dev,DC=com</AttributeValue><AttributeValue>CN=Central Desktop Users,CN=Users,DC=centraldesktop-dev,DC=com</AttributeValue></Attribute><Attribute Name=\"address1\"><AttributeValue>First Line Second Line</AttributeValue></Attribute></AttributeStatement><AuthnStatement AuthnInstant=\"2014-05-02T19:55:23.439Z\" SessionIndex=\"_79c35370-c286-453c-81a6-fc5a264a7b9a\"><AuthnContext><AuthnContextClassRef>urn:federation:authentication:windows</AuthnContextClassRef></AuthnContext></AuthnStatement></Assertion></samlp:Response>"),

            // this is bed xml with generated by ADFS windows CRLN
            array("<samlp:Response ID=\"_4e7997a7-1690-42a3-9f0e-c9cd1f7d2a74\" Version=\"2.0\" IssueInstant=\"2014-05-02T19:55:23.471Z\" Destination=\"https://qa.vminyaylo.centraldesktop-dev.com/saml2-assertion.php\" Consent=\"urn:oasis:names:tc:SAML:2.0:consent:unspecified\" InResponseTo=\"_4a7790ffe4e2b228e345d37e91c1\" xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\"><Issuer xmlns=\"urn:oasis:names:tc:SAML:2.0:assertion\">https://eng-auth0.centraldesktop-dev.com/adfs/services/trust</Issuer><samlp:Status><samlp:StatusCode Value=\"urn:oasis:names:tc:SAML:2.0:status:Success\" /></samlp:Status><Assertion ID=\"_cdfc1088-3ed4-4d37-bb76-7a5fce9b28b5\" IssueInstant=\"2014-05-02T19:55:23.471Z\" Version=\"2.0\" xmlns=\"urn:oasis:names:tc:SAML:2.0:assertion\"><Issuer>https://eng-auth0.centraldesktop-dev.com/adfs/services/trust</Issuer><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" /><ds:SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\" /><ds:Reference URI=\"#_cdfc1088-3ed4-4d37-bb76-7a5fce9b28b5\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" /><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" /></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\" /><ds:DigestValue>yfWQMGvRoDk3NiWcNrJlfrNkW+59hzMIuU6aJALWZQc=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>gBMH/9YXaTf9dWQYViQlYVUJEiy5xtB/gSaeSub2XCXiEzLQNfXfrCN6G+Ed6u5lbi68MavRNuZJvv2f4AU6ABJH8s0nHQpByIWlO3Z8wRd32WZ5RHrBScNRl4gwjA+RsIUrkBiVWEy5VPVzaYBd3mmSr8DPwIawkxtgHjRBno2fZa92/umdnWAlUc8cXQCa7PxuCOoc4uALHrdEnJ47MuT5dTwOl7JxoO4yBBcmt6s/ECjeL4uQDMfYXF66nZkLI2BE+LQRLMsag2v8eXwrsG9o/KJD36D2KP/AFxIYGCO4Osy9yvGSCP7U7XwOqHy1MuNy46+EceBrl+lKGZnZwg==</ds:SignatureValue><KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIC/DCCAeSgAwIBAgIQZGJgaN56E4BHraEF7tgu6TANBgkqhkiG9w0BAQsFADA6MTgwNgYDVQQDEy9BREZTIFNpZ25pbmcgLSBlbmctYXV0aDAuY2VudHJhbGRlc2t0b3AtZGV2LmNvbTAeFw0xNDA0MDQwMDI1NTRaFw0xNTA0MDQwMDI1NTRaMDoxODA2BgNVBAMTL0FERlMgU2lnbmluZyAtIGVuZy1hdXRoMC5jZW50cmFsZGVza3RvcC1kZXYuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtjH72YmawiYlD3hNqKQhkJXKvNa9QjovyVuRt8ieVazQZh02c1aJcI9RFt9ZhctNO1C3ve8xX/aULfMwgL3YCi6IwMJp2YQ/47Zp1mHEUAvw6PBAJdOVue4rku66hIxs0/vgtD75qf4WXhA1UlkZ/97CTHqG9BgqMb9B2b7AzM7Yv22VTkQ89i2XsW7efA5aNJAe99yE1ch3jP4xEegIaBdrkg8ojJGfRwtl8wJqz1zFDP/dXnqjT5Hn2nCnDdXYFuiGF/HzzaYpqTsh7aHu5DtipVicHAqXv5vyWh0zpuhPItPkP85fouCutqWMCnYQ81U1DbDCr95KP8r6NStLhQIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQA5pBkuxgU8hYbTz+I831nLt1BSGp584L8ers6ktawjD0PVwnSLWcUlri8h+ra/qAyjAathuz7l7uqMxBAeppayZCuMv2bR+NmRkmq73wS8tWAxJMed3OpTH8HLJ7U/1LDiSTGLihyeJ9fMLlgMg9nlQD6iwLRy+6lDWZhlTXCkPiP9gBxyYoCK4Dl8oKIn8KqYvhvlJ++MiO9wR7/5y+ShbZTetiPjxHvsymcMC4ZduC8yDQy/XPbPCALmnKaKXCLBIhhggunwHuWDSApEilf0A20ZkiKXc8aNrwoFTu7mR795RynPkzvpYCExjYSx9wRs+HCbTckBDIqVWaSxRrGa</ds:X509Certificate></ds:X509Data></KeyInfo></ds:Signature><Subject><NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress\">samltest@centraldesktop-dev.com</NameID><SubjectConfirmation Method=\"urn:oasis:names:tc:SAML:2.0:cm:bearer\"><SubjectConfirmationData InResponseTo=\"_4a7790ffe4e2b228e345d37e91c1\" NotOnOrAfter=\"2014-05-02T20:00:23.471Z\" Recipient=\"https://qa.vminyaylo.centraldesktop-dev.com/saml2-assertion.php\" /></SubjectConfirmation></Subject><Conditions NotBefore=\"2014-05-02T19:55:23.471Z\" NotOnOrAfter=\"2014-05-02T20:55:23.471Z\"><AudienceRestriction><Audience>https://qa.vminyaylo.centraldesktop-dev.com/saml2-metadata.php</Audience></AudienceRestriction></Conditions><AttributeStatement><Attribute Name=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress\"><AttributeValue>samltest@centraldesktop-dev.com</AttributeValue></Attribute><Attribute Name=\"fullname\"><AttributeValue>Saml Test</AttributeValue></Attribute><Attribute Name=\"firstname\"><AttributeValue>Saml</AttributeValue></Attribute><Attribute Name=\"lastname\"><AttributeValue>Test</AttributeValue></Attribute><Attribute Name=\"company\"><AttributeValue>SAML Company</AttributeValue></Attribute><Attribute Name=\"memberof\"><AttributeValue>CN=Test Group 1,CN=Users,DC=centraldesktop-dev,DC=com</AttributeValue><AttributeValue>CN=Central Desktop Users,CN=Users,DC=centraldesktop-dev,DC=com</AttributeValue></Attribute><Attribute Name=\"address1\"><AttributeValue>First Line\r\nSecond Line</AttributeValue></Attribute></AttributeStatement><AuthnStatement AuthnInstant=\"2014-05-02T19:55:23.439Z\" SessionIndex=\"_cdfc1088-3ed4-4d37-bb76-7a5fce9b28b5\"><AuthnContext><AuthnContextClassRef>urn:federation:authentication:windows</AuthnContextClassRef></AuthnContext></AuthnStatement></Assertion></samlp:Response>"),
        );
    }


    /**
     * @dataProvider data
     */
    public
    function testDigestValidationWithBadHack($str_xml) {

        $str_xml = preg_replace("/\r\n/","&#xD;&#xA;", $str_xml);

        $dom = new DOMDocument();
        $dom->loadXML($str_xml);
        $msg = SAML2_Message::fromXML($dom->firstChild);


        $this->assertInstanceOf('SAML2_Response', $msg);
    }

    /**
     * @dataProvider data
     */
    public
    function testDigestValidation($str_xml) {
        $dom = new DOMDocument();
        $dom->loadXML($str_xml);
        $msg = SAML2_Message::fromXML($dom->firstChild);


        $this->assertInstanceOf('SAML2_Response', $msg);
    }




}